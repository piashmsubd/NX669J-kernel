name: Build NX669J Kernel with DeepSeek AI

on:
  push:
    branches: [ main ]
  workflow_dispatch:

jobs:
  build:
    runs-on: ubuntu-20.04

    steps:
      # 1Ô∏è‚É£ ‡¶∞‡¶ø‡¶™‡ßã‡¶ú‡¶ø‡¶ü‡¶∞‡¶ø ‡¶ö‡ßá‡¶ï‡¶Ü‡¶â‡¶ü
      - name: Checkout Repository
        uses: actions/checkout@v3

      # 2Ô∏è‚É£ ‡¶¨‡¶ø‡¶≤‡ßç‡¶° ‡¶™‡¶∞‡¶ø‡¶¨‡ßá‡¶∂ ‡¶∏‡ßá‡¶ü‡¶Ü‡¶™
      - name: Setup Build Environment
        run: |
          sudo apt-get update
          sudo apt-get install -y git bc bison flex libssl-dev libelf-dev gcc-aarch64-linux-gnu make python2 wget xz-utils nodejs npm
          sudo ln -sf /usr/bin/python2 /usr/bin/python
          sudo apt-get install -y linux-headers-$(uname -r) || echo "Headers package not found!"

      # 3Ô∏è‚É£ Kernel Headers & Dependencies Fix
      - name: Fix Missing Kernel Headers
        run: |
          wget https://cdn.kernel.org/pub/linux/kernel/v5.x/linux-5.10.tar.xz
          tar -xf linux-5.10.tar.xz
          sudo cp -r linux-5.10/include/linux /usr/include/
        working-directory: ./

      # 4Ô∏è‚É£ Kernel Configuration Set
      - name: Configure Kernel for NX669J
        run: |
          make ARCH=arm64 CROSS_COMPILE=aarch64-linux-gnu- vendor/lahaina-NX669J-GKI_diff
          ./scripts/kconfig/merge_config.sh .config arch/configs/vendor/lahaina-NX669J_diff
          ls -l .config || echo ".config not found!"
        working-directory: msm-5.4

      # 5Ô∏è‚É£ Kernel Build Process
      - name: Build Kernel
        run: |
          sed -i 's/WERROR := 1/WERROR := 0/' Makefile || true
          make ARCH=arm64 CROSS_COMPILE=aarch64-linux-gnu- -j$(nproc) CFLAGS_KERNEL="-w" WERROR=0 || echo "BUILD_FAILED=true" >> $GITHUB_ENV
          ls -l arch/arm64/boot/Image || echo "Image not found!"
        working-directory: msm-5.4

      # 6Ô∏è‚É£ DeepSeek AI ‡¶¶‡¶ø‡ßü‡ßá Build Error ‡¶´‡¶ø‡¶ï‡ßç‡¶∏ ‡¶ï‡¶∞‡¶æ
      - name: Debug Kernel Build Issues with DeepSeek AI
        if: env.BUILD_FAILED == 'true'
        run: |
          echo "‚ö†Ô∏è Kernel Build Failed. Sending logs to DeepSeek AI for Debugging..."
          LOGS=$(tail -n 50 msm-5.4/0_build.txt | sed ':a;N;$!ba;s/\n/ /g')
          RESPONSE=$(curl -s -X POST "https://api.deepseek.com/v1/chat/completions" \
            -H "Authorization: Bearer ${{ secrets.DEEPSEEK_API_KEY }}" \
            -H "Content-Type: application/json" \
            -d '{
              "model": "deepseek-coder",
              "messages": [{"role": "user", "content": "Fix errors in kernel build: '"$LOGS"'"}],
              "max_tokens": 1000,
              "temperature": 0.7
            }')
          echo "üîç DeepSeek AI Suggestion:"
          echo "$RESPONSE" | jq -r '.choices[0].message.content'
        working-directory: msm-5.4

      # 7Ô∏è‚É£ ‡¶¨‡¶ø‡¶≤‡ßç‡¶° ‡¶Ü‡¶â‡¶ü‡¶™‡ßÅ‡¶ü ‡¶Ü‡¶™‡¶≤‡ßã‡¶°
      - name: Upload Kernel Image
        uses: actions/upload-artifact@v4
        with:
          name: NX669J-Kernel-Image
          path: msm-5.4/arch/arm64/boot/Image*

      # 8Ô∏è‚É£ GitHub Release (‡¶ê‡¶ö‡ßç‡¶õ‡¶ø‡¶ï)
      - name: Create Release
        if: success()
        uses: ncipollo/release-action@v1
        with:
          artifacts: "msm-5.4/arch/arm64/boot/Image"
          token: ${{ secrets.GITHUB_TOKEN }}
          tag: "kernel-v${{ github.run_number }}"
          name: "NX669J Kernel Build #${{ github.run_number }}"
