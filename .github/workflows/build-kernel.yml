name: Build NX669J Kernel with Copilot AI

on:
  push:
    branches: [ main ]
  workflow_dispatch:

jobs:
  build:
    runs-on: ubuntu-20.04

    steps:
      - name: Checkout Repository
        uses: actions/checkout@v3

      - name: Setup Build Environment
        run: |
          sudo apt-get update
          sudo apt-get install -y git bc bison flex libssl-dev libelf-dev gcc-aarch64-linux-gnu make python2 wget xz-utils nodejs npm
          sudo ln -sf /usr/bin/python2 /usr/bin/python
          sudo apt-get install -y linux-headers-$(uname -r) || echo "Headers package not found!"
          
      - name: Install GitHub Copilot CLI
        run: |
          npm install -g @githubnext/github-copilot-cli
          copilot auth
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

      - name: Configure Kernel
        run: |
          make ARCH=arm64 CROSS_COMPILE=aarch64-linux-gnu- gki_defconfig
          sed -i 's/WERROR := 1/WERROR := 0/' Makefile || true
        working-directory: ./msm-5.4

      - name: Build Kernel
        run: |
          make ARCH=arm64 CROSS_COMPILE=aarch64-linux-gnu- -j$(nproc) CFLAGS_KERNEL="-w" WERROR=0 || echo "BUILD_FAILED=true" >> $GITHUB_ENV
        working-directory: ./msm-5.4

      - name: Debug Kernel Build Issues with Copilot AI
        if: env.BUILD_FAILED == 'true'
        run: |
          echo "Kernel Build Failed. Sending logs to Copilot AI for Debugging..."
          LOGS=$(tail -n 50 msm-5.4/0_build.txt | sed ':a;N;$!ba;s/\n/ /g')
          copilot suggest "Fix errors in kernel build: $LOGS"
        working-directory: ./msm-5.4

      - name: Upload Kernel Image
        uses: actions/upload-artifact@v4
        with:
          name: NX669J-Kernel-Image
          path: msm-5.4/arch/arm64/boot/Image*
